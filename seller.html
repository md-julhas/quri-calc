<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>QuriCalc</title>
    <style>
      :root {
        --primary: #6d8c05;
        --secondary: #b3084f;
        --danger: #6d8c05;

        --bg: #060a17;
        --card-bg: #0c1325;
        --text: #989a9c;
        --border: #2d3140;
        --light-border: #3a4155;
        --lighter-bg: #1a2a4d;

        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);

        --radius-sm: 0.25rem;
        --radius: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;

        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-input: 22px;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        font-size: var(--text-base);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      body {
        max-width: 600px;
        margin: 0 auto;
        padding: 0.3rem;
      }

      /* Menu tabs */
      .menu {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 0.5rem 0.5rem;
      }

      .menu button {
        flex: 1;
        padding: 1rem;
        background: var(--bg);
        color: var(--text);
        font-weight: 600;
        border-radius: var(--radius-sm);
        font-size: var(--text-base);
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0;
      }

      .menu button.active {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      /* Card styling */
      .card {
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 0.5rem 0.5rem;
        margin-bottom: 1rem;
      }

      .seller-input {
        width: 100%;
      }

      /* Input row */
      .input-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      input[type="number"],
      input[type="text"],
      input[type="search"] {
        flex: 1;
        padding: 0.6rem;
        font-size: var(--text-input);
        border-radius: var(--radius-sm);
        border: 1px solid var(--bg);
        transition: all 0.2s;
        font-weight: bold;
        background-color: var(--bg);
        color: var(--primary);
      }

      input[type="number"]:focus,
      input[type="text"]:focus,
      input[type="search"]:focus {
        outline: none;
        border-color: var(--primary);
      }

      input.quantity-input {
        max-width: 100px;
      }
      input.price-input {
        width: 100%;
      }

      .bulk-options {
        display: flex;
        gap: 0.3rem;
        margin: 0;
      }

      .bulk-btn {
        margin: 0;
        padding: 0.9rem 0.5rem;
        font-size: var(--text-sm);
        font-weight: 600;
        border-radius: var(--radius-sm);
        background: #101733;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .bulk-btn.active {
        background: var(--primary);
        color: #d8d5d5;
      }

      .bulk-btn.active.bulk-8-btn {
        background: var(--secondary);
        color: #d8d5d5;
      }

      /* Buttons */
      button {
        padding: 1.3rem 1rem;
        font-weight: 600;
        border-radius: var(--radius-md);
        border: none;
        font-size: var(--text-base);
        cursor: pointer;
        background: var(--primary);
        color: white;
        width: 100%;
        margin: 1rem 0rem;
        transition: all 0.2s;
        box-shadow: var(--shadow-sm);
      }

      button.secondary {
        background: purple;
      }
      #add-btn {
        background-color: var(--card-bg);
        color: var(--text);
      }

      button.danger {
        background: var(--danger);
      }

      button.warning {
        background: var(--secondary);
      }

      /* Summary card */
      .summary {
        margin-top: 1rem;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 1rem;
        text-align: right;
      }

      .summary p,
      .summary div {
        font-size: var(--text-xl);
        margin: 0.5rem 0;
        color: var(--text);
      }

      .summary .total {
        font-weight: 600;
        color: var(--text);
      }

      #final-total {
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--primary);
        margin-top: 0.75rem;
      }

      /* Calculator item results */
      .calculator-item-results {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        padding-top: 0.5rem;
        border-top: 1px dashed var(--border);
      }

      .calculator-item-results > div {
        text-align: center;
      }

      .calculator-item-results .label {
        font-size: 0.7rem;
        color: var(--border);
        font-weight: 500;
        margin-bottom: 0.25rem;
      }

      .value {
        font-weight: bold;
      }

      .calculator-item-results .value {
        font-weight: 700;
        color: var(--text);
        font-size: var(--text-xl);
      }

      /* List view styles */
      #list-view {
        display: none;
        flex-direction: column;
        gap: 0.5rem;
      }

      .list-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .list-item {
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
        border: 1px solid transparent;
      }

      .list-item:hover {
        background-color: #101733;
        border-color: var(--primary);
      }

      .list-item:active {
        transform: scale(0.98);
        background-color: #1a2a4d;
        border-color: var(--primary);
      }

      .list-item.active-tap {
        background-color: #1a2a4d !important;
        transform: scale(0.98);
        transition: all 0.1s ease;
      }

      .list-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }

      .list-item-header .seller-name {
        font-size: var(--text-lg);
        color: var(--primary);
      }

      .list-item-header .seller-name.paid {
        color: var(--secondary);
      }

      /* Search bar */
      .search-container {
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 0.5rem;
      }

      .search-input {
        width: 100%;
      }

      input[type="search"]::-webkit-search-cancel-button {
        -webkit-appearance: none;
        height: 24px;
        width: 24px;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23989a9c"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>')
          no-repeat center center;
        background-size: contain;
        cursor: pointer;
      }

      input[type="search"]::-ms-clear {
        display: none;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        overflow-y: auto;
        padding: 1rem;
        animation: fadeIn 0.3s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 1rem;
        max-width: 600px;
        margin: 0 auto;
        box-shadow: var(--shadow-lg);
        transform: translateY(20px);
        animation: slideIn 0.3s ease-out forwards;
        animation-delay: 0.1s;
        opacity: 0;
      }

      @keyframes slideIn {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .modal-title {
        font-size: var(--text-2xl);
        color: var(--primary);
        font-weight: 700;
      }

      /* Paid */
      .modal-title.paid::after {
        content: "PAID";
        position: absolute;
        top: -0.5rem;
        right: 0;
        background-color: var(--secondary);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text);
        font-size: var(--text-3xl);
        cursor: pointer;
        padding: 0.5rem;
        width: fit-content;
        transition: color 0.2s ease;
      }

      .modal-close:hover {
        color: var(--secondary);
      }

      .modal-body {
        margin-bottom: 1.5rem;
        max-height: 50vh;
        overflow-y: auto;
      }

      .modal-item {
        background-color: var(--bg);
        border-radius: var(--radius-sm);
        padding: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
      }

      .modal-item-info {
        font-size: var(--text-lg);
        color: var(--text);
        flex-grow: 1;
      }

      .modal-item-info .bulk-8q {
        color: var(--secondary);
      }

      .modal-item-value {
        font-weight: 700;
        color: var(--text);
        font-size: var(--text-xl);
      }

      .modal-totals {
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px dashed var(--light-border);
      }

      .modal-total-row {
        display: flex;
        justify-content: space-between;
        margin: 0.75rem 0;
        font-size: var(--text-lg);
        font-weight: 500;
      }

      .modal-total-row span:last-child {
        font-weight: 700;
        color: var(--text);
      }

      .modal-final-total span:last-child {
        color: var(--primary);
      }

      .modal-final-total {
        font-weight: 700;
        color: var(--primary);
        font-size: var(--text-2xl);
        padding-top: 0.5rem;
        border-top: 1px dashed var(--light-border);
        margin-top: 1rem;
      }

      .modal-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
      }

      .modal-actions button {
        margin: 0;
        flex: 1;
        padding: 0.8rem 1rem;
        font-size: var(--text-base);
        border-radius: var(--radius-md);
        background-color: var(--lighter-bg);
        color: var(--text);
        border: 1px solid var(--light-border);
        box-shadow: none;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
      }

      .modal-actions button:hover {
        background-color: var(--bg);
      }

      .modal-actions button.warning {
        color: var(--secondary);
        border-color: var(--secondary);
      }

      .modal-actions button.danger {
        color: var(--danger);
        border-color: var(--danger);
      }

      .modal-actions button.secondary {
        color: purple;
        border-color: purple;
      }

      /* Overall summary */
      .overall-sellers-summary {
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }

      .overall-summary-row {
        display: flex;
        justify-content: space-around;
        align-items: center;
        font-size: var(--text-lg);
        color: var(--text);
        font-weight: 600;
      }

      .overall-summary-row span {
        flex: 1;
        text-align: center;
        white-space: nowrap;
        padding: 0.25rem 0;
      }

      .overall-summary-row .label {
        font-size: var(--text-sm);
        color: var(--border);
        font-weight: normal;
        margin-bottom: 0.25rem;
      }

      .overall-summary-row .value {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--primary);
      }

      /* No results message */
      .no-results {
        text-align: center;
        padding: 1rem;
        color: var(--text);
        font-style: italic;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        margin-top: 0.5rem;
      }

      /* Responsive adjustments */
      @media (max-width: 480px) {
        input.quantity-input {
          max-width: 60px;
        }

        .bulk-options {
          flex-shrink: 0;
        }

        .modal-content {
          padding: 1rem;
        }

        .modal-actions button {
          font-size: var(--text-sm);
          padding: 0.8rem;
        }
      }

      /* New message box styles */
      .message-box-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1500;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out forwards;
      }

      .message-box-content {
        background-color: var(--card-bg);
        padding: 2rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        text-align: center;
        max-width: 350px;
        width: 90%;
        color: var(--text);
        font-size: var(--text-lg);
        transform: translateY(20px);
        animation: slideIn 0.2s ease-out forwards;
        animation-delay: 0.1s;
        opacity: 0;
      }

      .message-box-content p {
        margin-bottom: 1.5rem;
        line-height: 1.4;
      }

      .message-box-content .message-box-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }

      .message-box-content .message-box-actions button {
        padding: 0.75rem 1.5rem;
        font-size: var(--text-base);
        font-weight: 600;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1; /* Make buttons expand equally */
        max-width: 120px; /* Limit button width */
        margin: 0; /* Override default button margin */
      }

      .message-box-content .message-box-actions button.confirm-yes {
        background-color: var(--primary);
        color: white;
      }

      .message-box-content .message-box-actions button.confirm-yes:hover {
        background-color: #5b7304; /* Darker primary */
      }

      .message-box-content .message-box-actions button.confirm-ok {
        background-color: var(--lighter-bg);
        color: var(--text);
        border: 1px solid var(--light-border);
      }

      .message-box-content .message-box-actions button.confirm-ok:hover {
        background-color: var(--bg);
      }
    </style>
  </head>
  <body>
    <div class="menu">
      <button id="calc-btn" class="active">Calculator</button>
      <button id="sellers-btn">Sellers</button>
    </div>

    <div id="calculator-view">
      <div class="card">
        <input
          type="text"
          id="seller-name"
          placeholder="Seller name"
          class="seller-input"
        />
      </div>

      <div id="items-container"></div>

      <button id="add-btn" class="secondary">+ Add Item</button>

      <div class="summary">
        <div class="total" id="total-amount">Raw Total: 0.00</div>
        <p id="commission-amount">Commission (10%): 0.00</p>
        <div id="final-total">Net Total: 0.00</div>
      </div>

      <button id="save-btn">Save Seller</button>
    </div>

    <div id="list-view">
      <div class="search-container">
        <input
          type="search"
          id="seller-search"
          placeholder="Search sellers..."
          class="search-input"
        />
      </div>

      <div id="list-content" class="list-container"></div>
    </div>

    <div
      id="overall-sellers-summary"
      class="overall-sellers-summary"
      style="display: none"
    >
      <div class="overall-summary-row">
        <div>
          <div class="label">Raw Total</div>
          <span id="overall-raw-total-value" class="value">0.00</span>
        </div>
        <div>
          <div class="label">Commission</div>
          <span id="overall-commission-total-value" class="value">0.00</span>
        </div>
        <div>
          <div class="label">Net Total</div>
          <span id="overall-final-net-total-value" class="value">0.00</span>
        </div>
      </div>
    </div>

    <button id="delete-all-sellers-btn" class="danger">
      Delete All Sellers
    </button>

    <div id="seller-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-seller-name"></h2>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-items-container"></div>
        <div class="modal-totals">
          <div class="modal-total-row">
            <span>Total Raw:</span>
            <span id="modal-total-raw">0.00</span>
          </div>
          <div class="modal-total-row">
            <span>Total Commission:</span>
            <span id="modal-total-commission">0.00</span>
          </div>
          <div class="modal-total-row modal-final-total">
            <span>Total Net:</span>
            <span id="modal-total-net">0.00</span>
          </div>
        </div>
        <div class="modal-actions">
          <button id="modal-paid-btn" class="warning">Mark Paid</button>
          <button id="modal-edit-btn" class="secondary">Edit</button>
          <button id="modal-delete-btn" class="danger">Delete</button>
        </div>
      </div>
    </div>

    <!-- New Message Box HTML -->
    <div
      id="message-box-overlay"
      class="message-box-overlay"
      style="display: none"
    >
      <div class="message-box-content">
        <p id="message-box-text"></p>
        <div class="message-box-actions">
          <button
            id="message-box-confirm-yes"
            class="confirm-yes"
            style="display: none"
          >
            Yes
          </button>
          <button id="message-box-confirm-ok" class="confirm-ok">OK</button>
        </div>
      </div>
    </div>

    <script>
      // Data structures
      let items = []
      let sellerName = ""
      const commissionPercent = 10
      let currentGlobalBulkOption = "9"
      let currentModalSellerIndex = -1

      // DOM Elements
      const itemsContainer = document.getElementById("items-container")
      const sellerNameInput = document.getElementById("seller-name")
      const totalAmountEl = document.getElementById("total-amount")
      const commissionAmountEl = document.getElementById("commission-amount")
      const finalTotalEl = document.getElementById("final-total")
      const addBtn = document.getElementById("add-btn")
      const saveBtn = document.getElementById("save-btn")

      // Menu buttons and views
      const calcBtn = document.getElementById("calc-btn")
      const sellersBtn = document.getElementById("sellers-btn")
      const calculatorView = document.getElementById("calculator-view")
      const listView = document.getElementById("list-view")
      const listContent = document.getElementById("list-content")
      const deleteAllSellersBtn = document.getElementById(
        "delete-all-sellers-btn"
      )
      const sellerSearchInput = document.getElementById("seller-search")

      // Overall sellers summary elements
      const overallSellersSummaryEl = document.getElementById(
        "overall-sellers-summary"
      )
      const overallRawTotalValueEl = document.getElementById(
        "overall-raw-total-value"
      )
      const overallCommissionTotalValueEl = document.getElementById(
        "overall-commission-total-value"
      )
      const overallFinalNetTotalValueEl = document.getElementById(
        "overall-final-net-total-value"
      )

      // Modal elements
      const sellerModal = document.getElementById("seller-modal")
      const modalSellerName = document.getElementById("modal-seller-name")
      const modalItemsContainer = document.getElementById(
        "modal-items-container"
      )
      const modalTotalRaw = document.getElementById("modal-total-raw")
      const modalTotalCommission = document.getElementById(
        "modal-total-commission"
      )
      const modalTotalNet = document.getElementById("modal-total-net")
      const modalPaidBtn = document.getElementById("modal-paid-btn")
      const modalEditBtn = document.getElementById("modal-edit-btn")
      const modalDeleteBtn = document.getElementById("modal-delete-btn")
      const modalCloseBtn = document.getElementById("modal-close")

      // Message Box Elements
      const messageBoxOverlay = document.getElementById("message-box-overlay")
      const messageBoxText = document.getElementById("message-box-text")
      const messageBoxConfirmYes = document.getElementById(
        "message-box-confirm-yes"
      )
      const messageBoxConfirmOk = document.getElementById(
        "message-box-confirm-ok"
      )

      // Functions
      function createItem() {
        return {
          quantity: null,
          price: null,
          rawAmount: 0,
          commission: 0,
          netAmount: 0,
          bulkOption: currentGlobalBulkOption,
        }
      }

      /**
       * Formats a number to two decimal places and adds comma separators.
       * @param {number} num - The number to format.
       * @returns {string} The formatted number string.
       */
      function formatNumber(num) {
        if (num === null || isNaN(num)) return "0.00"
        return parseFloat(num)
          .toFixed(2)
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
      }

      /**
       * Formats a price, removing decimals if it's a whole number.
       * @param {number} price - The price to format.
       * @returns {string} The formatted price string.
       */
      function formatPrice(price) {
        if (price === null || isNaN(price)) return "0"
        const num = parseFloat(price)
        if (num % 1 === 0) {
          // Check if it's an integer
          return num.toString()
        }
        return num.toFixed(2)
      }

      /**
       * Calculates the raw amount, commission, and net amount for a given item.
       * @param {object} item - The item object to calculate amounts for.
       */
      function calculateItemAmounts(item) {
        const bulkValue = item.bulkOption === "8" ? 72 : 64
        item.rawAmount = ((item.price || 0) * (item.quantity || 0)) / bulkValue
        item.commission = item.rawAmount * (commissionPercent / 100)
        item.netAmount = item.rawAmount - item.commission
      }

      /**
       * Updates the summary display (Raw Total, Commission, Net Total) based on current items.
       */
      function updateSummary() {
        const totalRaw = items.reduce(
          (sum, item) => sum + (item.rawAmount || 0),
          0
        )
        const totalCommission = items.reduce(
          (sum, item) => sum + (item.commission || 0),
          0
        )
        const totalNet = items.reduce(
          (sum, item) => sum + (item.netAmount || 0),
          0
        )

        totalAmountEl.innerHTML = `Raw Total: <b>${formatNumber(totalRaw)}</b>`
        commissionAmountEl.textContent = `Commission (${commissionPercent}%): ${formatNumber(
          totalCommission
        )}`
        finalTotalEl.textContent = `Net Total: ${formatNumber(totalNet)}`
      }

      /**
       * Updates the display of a single item's calculated values.
       * @param {HTMLElement} itemCard - The DOM element representing the item card.
       * @param {object} item - The item object with updated values.
       */
      function updateItemDisplay(itemCard, item) {
        const rawTotalDiv = itemCard.querySelector(".raw-total-value")
        const commissionDiv = itemCard.querySelector(".commission-value")
        const netAmountDiv = itemCard.querySelector(".net-amount-value")

        if (rawTotalDiv) rawTotalDiv.textContent = formatNumber(item.rawAmount)
        if (commissionDiv)
          commissionDiv.textContent = formatNumber(item.commission)
        if (netAmountDiv)
          netAmountDiv.textContent = formatNumber(item.netAmount)
      }

      /**
       * Renders all items in the calculator view.
       * @param {boolean} focusLast - If true, focuses on the quantity input of the last item.
       */
      function renderItems(focusLast = false) {
        itemsContainer.innerHTML = ""

        items.forEach((item, index) => {
          const card = document.createElement("div")
          card.className = "card"

          const inputRow = document.createElement("div")
          inputRow.className = "input-row"

          const quantityInput = document.createElement("input")
          quantityInput.type = "number"
          quantityInput.className = "quantity-input"
          quantityInput.placeholder = "Qty"
          quantityInput.value = item.quantity ?? ""
          quantityInput.addEventListener("input", (e) => {
            item.quantity = parseInt(e.target.value) || null
            calculateItemAmounts(item)
            updateSummary()
            updateItemDisplay(card, item)
          })

          const priceInput = document.createElement("input")
          priceInput.type = "number"
          priceInput.className = "price-input"
          priceInput.placeholder = "Price"
          priceInput.value = item.price ?? ""
          priceInput.addEventListener("input", (e) => {
            item.price = parseFloat(e.target.value) || null
            calculateItemAmounts(item)
            updateSummary()
            updateItemDisplay(card, item)
          })

          priceInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === "Next") {
              if (index === items.length - 1) {
                addBtn.click()
              }
            }
          })

          const bulkOptions = document.createElement("div")
          bulkOptions.className = "bulk-options"

          const bulk9Btn = document.createElement("button")
          bulk9Btn.className = `bulk-btn ${
            item.bulkOption === "9" ? "active" : ""
          }`
          bulk9Btn.textContent = "9 quad"
          bulk9Btn.title = "Divide by 64"
          bulk9Btn.addEventListener("click", () => {
            item.bulkOption = "9"
            calculateItemAmounts(item)
            updateSummary()
            updateItemDisplay(card, item)
            bulk9Btn.classList.add("active")
            bulk8Btn.classList.remove("active")
            bulk8Btn.classList.remove("bulk-8-btn")
          })

          const bulk8Btn = document.createElement("button")
          bulk8Btn.className = `bulk-btn ${
            item.bulkOption === "8" ? "active bulk-8-btn" : ""
          }`
          bulk8Btn.textContent = "8 quad"
          bulk8Btn.title = "Divide by 72"
          bulk8Btn.addEventListener("click", () => {
            item.bulkOption = "8"
            calculateItemAmounts(item)
            updateSummary()
            updateItemDisplay(card, item)
            bulk8Btn.classList.add("active", "bulk-8-btn")
            bulk9Btn.classList.remove("active")
          })

          bulkOptions.appendChild(bulk9Btn)
          bulkOptions.appendChild(bulk8Btn)

          inputRow.appendChild(quantityInput)
          inputRow.appendChild(priceInput)
          inputRow.appendChild(bulkOptions)

          const results = document.createElement("div")
          results.className = "calculator-item-results"

          results.innerHTML = `
            <div>
              <div class="label">Raw Total</div>
              <div class="value raw-total-value">${formatNumber(
                item.rawAmount
              )}</div>
            </div>
            <div>
              <div class="label">Commission</div>
              <div class="value commission-value">${formatNumber(
                item.commission
              )}</div>
            </div>
            <div>
              <div class="label">Net Amount</div>
              <div class="value net-amount-value">${formatNumber(
                item.netAmount
              )}</div>
            </div>
          `

          card.appendChild(inputRow)
          card.appendChild(results)
          itemsContainer.appendChild(card)

          if (focusLast && index === items.length - 1) {
            setTimeout(() => quantityInput.focus(), 0)
          }
        })

        updateSummary()
      }

      addBtn.addEventListener("click", () => {
        items.push(createItem())
        renderItems(true)
      })

      sellerNameInput.addEventListener("input", () => {
        sellerName = sellerNameInput.value.trim()
      })

      saveBtn.addEventListener("click", () => {
        sellerName = sellerNameInput.value.trim()
        if (!sellerName) {
          // Replaced alert with a custom message box for better user experience
          showMessageBox("Please enter a seller name before saving.", "Error")
          return
        }
        if (
          items.length === 0 ||
          items.every(
            (item) =>
              item.quantity === null ||
              item.price === null ||
              item.quantity === 0 ||
              item.price === 0
          )
        ) {
          showMessageBox(
            "Please add at least one item with valid quantity and price before saving.",
            "Error"
          )
          return
        }

        for (let i = 0; i < items.length; i++) {
          if (
            items[i].quantity === null ||
            items[i].price === null ||
            items[i].quantity === 0 ||
            items[i].price === 0
          ) {
            showMessageBox(
              `Please enter valid quantity and price for item #${i + 1}`,
              "Error"
            )
            return
          }
        }

        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )

        const currentSellerTotalRaw = items.reduce(
          (sum, item) => sum + item.rawAmount,
          0
        )
        const currentSellerTotalCommission = items.reduce(
          (sum, item) => sum + item.commission,
          0
        )
        const currentSellerTotalNet = items.reduce(
          (sum, item) => sum + item.netAmount,
          0
        )

        sellersData.push({
          sellerName,
          commissionPercent,
          items: items.map((i) => ({
            quantity: i.quantity,
            price: i.price,
            rawAmount: i.rawAmount,
            commission: i.commission,
            netAmount: i.netAmount,
            bulkOption: i.bulkOption,
          })),
          totalRaw: currentSellerTotalRaw,
          totalCommission: currentSellerTotalCommission,
          totalNet: currentSellerTotalNet,
          savedAt: new Date().toISOString(),
          isPaid: false,
        })

        localStorage.setItem("sellersData", JSON.stringify(sellersData))

        sellerNameInput.value = ""
        items = [createItem()]
        sellerName = ""
        currentGlobalBulkOption = "9"
        renderItems()
        updateSummary()
        // Removed: showMessageBox("Seller data saved successfully!", "Success");
      })

      /**
       * Shows the calculator view and hides other views.
       */
      function showCalculatorView() {
        calcBtn.classList.add("active")
        sellersBtn.classList.remove("active")
        calculatorView.style.display = "block"
        listView.style.display = "none"
        overallSellersSummaryEl.style.display = "none" // Hide when on calculator view
        deleteAllSellersBtn.style.display = "none" // Hide when on calculator view
      }

      /**
       * Loads a seller's data into the calculator for editing.
       * @param {number} sellerIndex - The index of the seller to load.
       */
      function loadSellerForEdit(sellerIndex) {
        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )
        const sellerToEdit = sellersData[sellerIndex]

        if (sellerToEdit) {
          sellerNameInput.value = sellerToEdit.sellerName
          // Deep copy items to avoid modifying original array until saved
          items = sellerToEdit.items.map((item) => ({ ...item }))

          // Recalculate amounts in case commission percent changed or other logic updated
          items.forEach((item) => calculateItemAmounts(item))

          // Remove the seller from the list, as it's now being edited
          sellersData.splice(sellerIndex, 1)
          localStorage.setItem("sellersData", JSON.stringify(sellersData))

          renderItems()
          showCalculatorView()
          closeModal()
        }
      }

      /**
       * Deletes a seller's data from local storage.
       * @param {number} index - The index of the seller to delete.
       */
      function deleteSeller(index) {
        showMessageBox(
          "Are you sure you want to delete this seller's data?",
          "Confirm",
          () => {
            const sellersData = JSON.parse(
              localStorage.getItem("sellersData") || "[]"
            )
            sellersData.splice(index, 1)
            localStorage.setItem("sellersData", JSON.stringify(sellersData))
            showSellersList() // Re-render list and update summary after deletion
            closeModal()
            // showMessageBox("Seller data deleted successfully.", "Success"); // Removed this line
          }
        )
      }

      /**
       * Deletes all sellers data from local storage.
       */
      function deleteAllSellers() {
        showMessageBox(
          "Are you sure you want to delete ALL sellers data? This action cannot be undone.",
          "Confirm",
          () => {
            localStorage.removeItem("sellersData")
            showSellersList() // Re-render list and update summary
            showMessageBox("All sellers data has been deleted.", "Success")
          }
        )
      }

      /**
       * Toggles the paid status of a seller.
       * @param {number} index - The index of the seller to toggle.
       */
      function toggleSellerPaidStatus(index) {
        let sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )
        if (sellersData[index]) {
          sellersData[index].isPaid = !sellersData[index].isPaid
          localStorage.setItem("sellersData", JSON.stringify(sellersData))
          showSellersList() // Re-render list to reflect paid status
          // Update the modal if it's open for the same seller
          if (currentModalSellerIndex === index) {
            showSellerModal(index)
          }
        }
      }

      /**
       * Updates the overall summary display for all sellers.
       */
      function updateOverallSellersSummary() {
        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )
        let overallRaw = 0
        let overallCommission = 0
        let overallNet = 0

        sellersData.forEach((seller) => {
          overallRaw += seller.totalRaw || 0
          overallCommission += seller.totalCommission || 0
          overallNet += seller.totalNet || 0
        })

        overallRawTotalValueEl.textContent = formatNumber(overallRaw)
        overallCommissionTotalValueEl.textContent =
          formatNumber(overallCommission)
        overallFinalNetTotalValueEl.textContent = formatNumber(overallNet)

        if (sellersData.length > 0) {
          overallSellersSummaryEl.style.display = "block"
        } else {
          overallSellersSummaryEl.style.display = "none"
        }
      }

      /**
       * Filters sellers based on a search term.
       * @param {string} searchTerm - The term to search for.
       * @returns {Array} An array of filtered seller objects.
       */
      function filterSellers(searchTerm) {
        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )

        if (!searchTerm) {
          return sellersData
        }

        const searchWords = searchTerm.toLowerCase().split(/\s+/)

        return sellersData.filter((seller) => {
          const sellerName = seller.sellerName.toLowerCase()
          return searchWords.every((word) => sellerName.includes(word))
        })
      }

      /**
       * Shows the list of sellers and updates the overall summary.
       */
      function showSellersList() {
        const searchTerm = sellerSearchInput.value.trim()
        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )
        const filteredSellers = filterSellers(searchTerm)

        listContent.innerHTML = ""

        if (filteredSellers.length === 0) {
          listContent.innerHTML = `
            <div class="no-results">
              ${
                searchTerm
                  ? "No matching sellers found"
                  : "No sellers data saved yet"
              }
            </div>
          `
          deleteAllSellersBtn.style.display = "none" // Always hide if no sellers
          overallSellersSummaryEl.style.display = "none" // Always hide if no sellers
          return
        }

        filteredSellers.forEach((filteredSeller, filteredIndex) => {
          // Find the original index in the full sellersData array
          // This is important because filteredIndex might not match originalIndex after filtering
          const originalIndex = sellersData.findIndex(
            (seller) =>
              seller.sellerName === filteredSeller.sellerName &&
              seller.savedAt === filteredSeller.savedAt
          )

          const sellerDiv = document.createElement("div")
          sellerDiv.className = "list-item"
          sellerDiv.innerHTML = `
            <div class="list-item-header">
              <span class="seller-name ${
                filteredSeller.isPaid ? "paid" : ""
              }">${filteredSeller.sellerName}</span>
              <span>${formatNumber(filteredSeller.totalNet)}</span>
            </div>
            `

          // Add touch feedback
          let tapTimer
          sellerDiv.addEventListener("touchstart", () => {
            sellerDiv.classList.add("active-tap")
            tapTimer = setTimeout(() => {
              sellerDiv.classList.remove("active-tap")
            }, 200)
          })

          sellerDiv.addEventListener("touchend", () => {
            clearTimeout(tapTimer)
            sellerDiv.classList.remove("active-tap")
          })

          sellerDiv.addEventListener("click", (e) => {
            e.preventDefault()
            showSellerModal(originalIndex) // Use originalIndex to open the correct modal
          })

          listContent.appendChild(sellerDiv)
        })

        // Show/hide buttons based on actual data presence, not just filtered count
        if (sellersData.length > 0) {
          deleteAllSellersBtn.style.display = "block"
        } else {
          deleteAllSellersBtn.style.display = "none"
        }

        updateOverallSellersSummary() // Ensure summary is updated based on ALL sellers
      }

      /**
       * Shows the detailed seller modal.
       * @param {number} index - The index of the seller to display in the modal.
       */
      function showSellerModal(index) {
        const sellersData = JSON.parse(
          localStorage.getItem("sellersData") || "[]"
        )
        const seller = sellersData[index]

        if (!seller) return

        currentModalSellerIndex = index
        modalSellerName.textContent = seller.sellerName

        // Update the paid status class and button text
        if (seller.isPaid) {
          modalSellerName.classList.add("paid")
          modalPaidBtn.textContent = "Unmark Paid"
        } else {
          modalSellerName.classList.remove("paid")
          modalPaidBtn.textContent = "Mark Paid"
        }

        modalEditBtn.textContent = "Edit"
        modalDeleteBtn.textContent = "Delete"

        // Render items
        modalItemsContainer.innerHTML = ""
        seller.items.forEach((item, itemIndex) => {
          // Added itemIndex for serial number
          const itemElement = document.createElement("div")
          itemElement.className = "modal-item"

          const bulkText =
            item.bulkOption === "8" ? '<span class="bulk-8q">8Q</span>' : "9Q" // Conditional styling for 8Q

          itemElement.innerHTML = `
            <div class="modal-item-info">
              ${itemIndex + 1}) ${item.quantity} x ${formatPrice(
            item.price
          )} / ${bulkText}
            </div>
            <div class="modal-item-value">${formatNumber(item.rawAmount)}</div>
          `
          modalItemsContainer.appendChild(itemElement)
        })

        // Update totals
        modalTotalRaw.textContent = formatNumber(seller.totalRaw)
        modalTotalCommission.textContent = formatNumber(seller.totalCommission)
        modalTotalNet.textContent = formatNumber(seller.totalNet)

        // Show modal
        sellerModal.style.display = "block"
      }

      /**
       * Closes the detailed seller modal.
       */
      function closeModal() {
        sellerModal.style.display = "none"
        currentModalSellerIndex = -1
      }

      /**
       * Displays a custom message box.
       * @param {string} message - The message to display.
       * @param {string} type - "Success", "Error", or "Confirm".
       * @param {function} onConfirm - Callback function for "Confirm" type if "Yes" is clicked.
       */
      function showMessageBox(message, type, onConfirm = null) {
        messageBoxText.textContent = message

        if (type === "Confirm") {
          messageBoxConfirmYes.style.display = "inline-block"
          messageBoxConfirmOk.textContent = "No"
          messageBoxConfirmYes.onclick = () => {
            messageBoxOverlay.style.display = "none"
            if (onConfirm) onConfirm()
          }
          messageBoxConfirmOk.onclick = () => {
            messageBoxOverlay.style.display = "none"
          }
        } else {
          messageBoxConfirmYes.style.display = "none"
          messageBoxConfirmOk.textContent = "OK"
          messageBoxConfirmOk.onclick = () => {
            messageBoxOverlay.style.display = "none"
          }
        }
        messageBoxOverlay.style.display = "flex"
      }

      // Modal event listeners
      modalCloseBtn.addEventListener("click", closeModal)

      modalPaidBtn.addEventListener("click", () => {
        if (currentModalSellerIndex >= 0) {
          toggleSellerPaidStatus(currentModalSellerIndex)
        }
      })

      modalEditBtn.addEventListener("click", () => {
        if (currentModalSellerIndex >= 0) {
          loadSellerForEdit(currentModalSellerIndex)
        }
      })

      modalDeleteBtn.addEventListener("click", () => {
        if (currentModalSellerIndex >= 0) {
          deleteSeller(currentModalSellerIndex)
        }
      })

      // Close modal when clicking outside
      window.addEventListener("click", (e) => {
        if (e.target === sellerModal) {
          closeModal()
        }
      })

      // Close message box when clicking outside
      messageBoxOverlay.addEventListener("click", (e) => {
        if (e.target === messageBoxOverlay) {
          messageBoxOverlay.style.display = "none"
        }
      })

      calcBtn.addEventListener("click", showCalculatorView)

      sellersBtn.addEventListener("click", () => {
        calcBtn.classList.remove("active")
        sellersBtn.classList.add("active")
        calculatorView.style.display = "none"
        listView.style.display = "flex"
        showSellersList() // This function will handle showing/hiding summary and delete button
      })

      deleteAllSellersBtn.addEventListener("click", deleteAllSellers)

      sellerSearchInput.addEventListener("input", () => {
        showSellersList()
      })

      // Initialize with one empty item
      items.push(createItem())
      renderItems()
      // Initially hide the overall summary and delete button on page load
      overallSellersSummaryEl.style.display = "none"
      deleteAllSellersBtn.style.display = "none"
    </script>
  </body>
</html>
